<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <title>图片上传</title>
    <link rel="stylesheet" href="css/mdui.min.css"/>
    <style type="text/css">
        .body-img {
            background: url(image/bg.jpg) no-repeat;
            background-size: 100% 100%;
            background-attachment: fixed;
        }

        .body-img1 {
            width: 95%;
            margin: 0 auto;
            background: url(image/screen-bg.png) no-repeat;
            background-size: 100% 100%;
            padding-top: 5%;
            padding-bottom: 10%;
        }

        .body-img2 {
            width: 90%;
            margin: 0 auto;
            background: url(image/screen.png) no-repeat;
            background-size: 100% 100%;
        }

        .img-set {
            width: 100%;
        }

        .row-set {
            width: 100%;
            padding-left: 6%;
            line-height: 0;
        }
    </style>
</head>
<body class="body-img">
<div class="body-img1" id="capture">
    <div class="body-img2">
        <div class="mdui-container">
            <p></p>
            <div class="mdui-row mdui-row-gapless row-set" style="padding-top: 9.5%;">
                <div class="mdui-col-xs-1 mdui-col-offset-xs-1">
                    <img class="img-set" id="img-1" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-2" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-3" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1 mdui-col-offset-xs-3">
                    <img class="img-set" id="img-4" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-5" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-6" src="image/loading.jpg">
                </div>
            </div>
            <div class="mdui-row mdui-row-gapless row-set">
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-7" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-8" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-9" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-10" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-11" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1 mdui-col-offset-xs-1">
                    <img class="img-set" id="img-12" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-13" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-14" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-15" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-16" src="image/loading.jpg">
                </div>
            </div>
            <div class="mdui-row mdui-row-gapless row-set">
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-17" src="image/loading.jpg">
                    <img class="img-set" id="img-18" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-3">
                    <img class="img-set" id="img-19" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-3">
                    <form id="img-form" enctype="multipart/form-data">
                        <input id="img-input" name="file" type="file" accept="image/*" style="display: none"/>
                        <label for="img-input" id="img-set-label">
                            <a href="#"><img class="img-set" id="img-uploaded" src="image/loading.jpg"></a>
                        </label>
                    </form>
                </div>
                <div class="mdui-col-xs-3">
                    <img class="img-set" id="img-20" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-21" src="image/loading.jpg">
                    <img class="img-set" id="img-22" src="image/loading.jpg">
                </div>
            </div>
            <div class="mdui-row mdui-row-gapless row-set">
                <div class="mdui-col-xs-1 mdui-col-offset-xs-2">
                    <img class="img-set" id="img-23" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-24" src="image/loading.jpg">
                    <img class="img-set" id="img-25" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-3">
                    <img class="img-set" id="img-26" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-27" src="image/loading.jpg">
                    <img class="img-set" id="img-28" src="image/loading.jpg">
                </div>
                <div class="mdui-col-xs-1">
                    <img class="img-set" id="img-29" src="image/loading.jpg">
                </div>
            </div>
            <div class="mdui-row mdui-row-gapless"
                 style="width: 100%;padding-left: 6%;padding-bottom: 8%;line-height:0;">
                <div class="mdui-col-xs-1 mdui-col-offset-xs-5">
                    <img class="img-set" id="img-30" src="image/loading.jpg">
                </div>
            </div>
        </div>
    </div>
    <div style="vertical-align: bottom;" onclick="loadImage()">
        <img class="img-set" src="image/control.png">
    </div>
</div>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/mdui.min.js"></script>
<script type="text/javascript" src="js/html2canvas.min.js"></script>
<script type="text/javascript">
    // var $ = mdui.$;

    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i].trim();
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    var randomDic = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];

    function generateMixed(n) {
        var res = "";
        for (var i = 0; i < n; i++) {
            var id = Math.ceil(Math.random() * 35);
            res += randomDic[id];
        }
        return res;
    }

    function genSessionKey() {
        return generateMixed(32)
    }

    function zzInit() {
        if (getCookie("zzsession") === "") {
            setCookie("zzsession", genSessionKey(), 30)
        }
        if (getCookie("oldimg") !== "") {
            loadImageToBox("#img-uploaded", getCookie("oldimg"))
        }
    }

    function loadImageToBox(id, fn) {
        var imgSrc = "/api/getImage.do?fn=" + fn
        $(id).attr("src", imgSrc);
        console.log("set", id, "to", imgSrc)
    }

    function loadImage() {
        $.ajax({
            method: 'GET',
            url: '/api/getRand.do',
            data: {
                "count": 30
            },
            dataType: "json",
            success: function (data) {
                console.log(data);
                if (data["status"] === 0) {
                    for (var i in data["obj"]) {
                        console.log(i, ":", data["obj"][i])
                        var id = "#img-" + (parseInt(i) + 1)
                        loadImageToBox(id, data["obj"][i]["filename"])
                    }
                }
            }
        });
    }

    function uploadImage() {
        var image = $("#img-input")[0].files[0];
        var formData = new FormData();
        formData.append("file", image)
        $.ajax({
            type: 'POST',
            url: '/api/uploadImage.do',
            data: formData,
            cache: false,
            processData: false,
            contentType: false,
            success: function (data) {
                console.log(data);
                if (data["status"] === 0) {
                    console.log("上传成功")
                    setCookie("oldimg", data["obj"], 60)
                    loadImageToBox("#img-uploaded", getCookie("oldimg"))
                }
            },
            error: function (data) {
                console.log(data)
            }
        });
    }

    function getScreenshot() {
        html2canvas(document.getElementById('capture')).then(function (canvas) {
            canvas.toBlob(function (blob) {
                var url = URL.createObjectURL(blob);
                mdui.alert('<div style="width: 100%; height: 256px"><img class="mdui-img-fluid" src="' + url + '" alt="请长按保存" /></div>', '请长按保存');
            });
        });
    }

    window.onload = function () {
        loadImage()
        $("#img-set-label").on("click", function (e) {
            $("#img-input").trigger("click");
        })
        $("#img-input").on("change", function (e) {
            uploadImage()
        });
        zzInit()
    }
</script>
</body>
</html>
