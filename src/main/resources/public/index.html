<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <title>北城青年陪你一起奔向2021</title>
    <link rel="stylesheet" href="css/mdui.min.css"/>
    <style type="text/css">

        .body-img {
            background: url(image/bg.jpg) repeat-y;
            background-size: cover;
        }

        .body-img1 {
            width: 95%;
            margin: 0 auto;
            background: url(image/screen-bg.png) no-repeat;
            background-size: 100% 100%;
            padding-top: 5%;
            padding-bottom: 10%;
        }

        .body-img2 {
            width: 90%;
            margin: 0 auto;
            background: url(image/screen.png) no-repeat;
            background-size: 100% 100%;
        }

        .img-set {
            width: 100%;
            height: 100%;
        }

        .row-set {
            width: 100%;
            padding-left: 6%;
            line-height: 0;
        }

        .footer {
            left: 0;
            bottom: 0;
            width: 100%;
            padding-top: 64px;
            line-height:0;
        }
    </style>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/mdui.min.js"></script>
    <script type="text/javascript" src="js/html2canvas.min.js"></script>
    <script type="text/javascript" src="js/zz.js"></script>
</head>
<body class="body-img">
<p></p>
<div id="capture">
    <div class="body-img1">
        <img class="img-set" src="image/title.png">
        <div class="body-img2">
            <div class="mdui-container">
                <p></p>
                <div class="mdui-row mdui-row-gapless row-set" style="padding-top: 9.5%;">
                    <div class="mdui-col-xs-1 mdui-col-offset-xs-1">
                        <img class="img-set" id="img-1" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-2" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-3" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1 mdui-col-offset-xs-3">
                        <img class="img-set" id="img-4" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-5" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-6" src="image/loading.png">
                    </div>
                </div>
                <div class="mdui-row mdui-row-gapless row-set">
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-7" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-8" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-9" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-10" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-11" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1 mdui-col-offset-xs-1">
                        <img class="img-set" id="img-12" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-13" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-14" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-15" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-16" src="image/loading.png">
                    </div>
                </div>
                <div class="mdui-row mdui-row-gapless row-set">
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-17" src="image/loading.png">
                        <img class="img-set" id="img-18" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-3">
                        <img class="img-set" id="img-19" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-3">
                        <input id="img-input" name="file" type="file" accept="image/*" style="display: none"/>
                        <label for="img-input" id="img-set-label">
                            <img class="img-set" id="img-uploaded" src="image/img-upload.jpg">
                        </label>
                    </div>
                    <div class="mdui-col-xs-3">
                        <img class="img-set" id="img-20" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-21" src="image/loading.png">
                        <img class="img-set" id="img-22" src="image/loading.png">
                    </div>
                </div>
                <div class="mdui-row mdui-row-gapless row-set">
                    <div class="mdui-col-xs-1 mdui-col-offset-xs-2">
                        <img class="img-set" id="img-23" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-24" src="image/loading.png">
                        <img class="img-set" id="img-25" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-3">
                        <img class="img-set" id="img-26" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-27" src="image/loading.png">
                        <img class="img-set" id="img-28" src="image/loading.png">
                    </div>
                    <div class="mdui-col-xs-1">
                        <img class="img-set" id="img-29" src="image/loading.png">
                    </div>
                </div>
                <div class="mdui-row mdui-row-gapless row-set" style="padding-bottom: 8%;">
                    <div class="mdui-col-xs-1 mdui-col-offset-xs-5">
                        <img class="img-set" id="img-30" src="image/loading.png">
                    </div>
                </div>
            </div>
        </div>
        <div class="mdui-row mdui-row-gapless row-set">
            <div class="mdui-col-xs-6">
                <div style="vertical-align: bottom;" onclick="getScreenshot()">
                    <img class="img-set no-screenshot" src="image/screen-cut.png">
                </div>
            </div>
            <div class="mdui-col-xs-6">
                <div style="vertical-align: bottom;" onclick="loadImage()">
                    <img class="img-set" src="image/control.png">
                </div>
            </div>
        </div>
    </div>
    <div class="mdui-container">
        <img class="img-set" src="image/logo.png" style="padding-top: 20px;padding-bottom: 20px">
        <div class="mdui-typo mdui-text-center no-screenshot">
            <p style="color: #616161;line-height: 15px;">由北城青年联合阿里云大数据学院数创未来工作室开发</p>
            <p style="color: #616161;line-height: 15px;">制作人：张哲、鞠一辰&emsp;联合制作：杨硕&emsp;审阅：李佳卿</p>
        </div>
    </div>
</div>

<div class="footer">
    <img src="image/bg-footer.jpg" style="width: 100%;">
</div>

<div class="mdui-dialog" id="dialog-readme">
    <div class="mdui-dialog-content">
        <div class="mdui-dialog-title">使用帮助</div>
        <p>
            通过图片墙，和其他朋友一起分享你的独家2020记忆！
        </p>
        <img src="image/readme.png" width="100%">
        <p>
            图片上传后经过审核，就会出现在其他人的图片墙里作为背景中的一部分，让我们在2020年的最后一天把记忆传递留存下去吧！
        </p>
    </div>
    <div class="mdui-dialog-actions">
        <button class="mdui-btn mdui-ripple" mdui-dialog-close>开始记录你的2020</button>
    </div>
</div>

<script type="text/javascript">
    // var $ = mdui.$;

    function zzInit() {
        if (getCookie("zzsession") === "") {
            setCookie("zzsession", genSessionKey(), 30)
        }
        if (getCookie("oldimg") !== "") {
            loadImageToBox("#img-uploaded", getCookie("oldimg"))
        }
        if (getCookie("zz201231firstrun") === "") {
            setCookie("zz201231firstrun", "1", 1)
            setTimeout(function () {
                var readmeDialog = new mdui.Dialog('#dialog-readme');
                readmeDialog.open()
            }, 500);
        }
    }

    function loadImageToBox(id, fn) {
        var imgSrc = "/api/getImage.do?fn=" + fn
        $(id).attr("src", imgSrc);
        console.log("set", id, "to", imgSrc)
    }

    function loadImage() {
        $.ajax({
            method: 'GET',
            url: '/api/getRand.do',
            data: {
                "count": 30
            },
            dataType: "json",
            success: function (data) {
                console.log(data);
                if (data["status"] === 0) {
                    for (var i in data["obj"]) {
                        console.log(i, ":", data["obj"][i])
                        var id = "#img-" + (parseInt(i) + 1)
                        loadImageToBox(id, data["obj"][i]["filename"])
                    }
                }
            }
        });
    }

    function uploadImage() {
        var image = $("#img-input")[0].files[0];
        var formData = new FormData();
        formData.append("file", image)
        $.ajax({
            type: 'POST',
            url: '/api/uploadImage.do',
            data: formData,
            cache: false,
            processData: false,
            contentType: false,
            success: function (data) {
                console.log(data);
                if (data["status"] === 0) {
                    console.log("上传成功")
                    setCookie("oldimg", data["obj"], 60)
                    loadImageToBox("#img-uploaded", getCookie("oldimg"))
                }
            },
            error: function (data) {
                console.log(data)
            }
        });
    }

    function snackBar(msg, timeout){
        mdui.snackbar({
            message: msg,
            position: 'top',
            timeout: timeout
        });
    }

    function hideNoScreenshotElement() {
        var elems = document.getElementsByClassName("no-screenshot")
        for (var t of elems) {
            // t.style.visibility = 'hidden';
            t.style.display = 'none';
        }
    }

    function showNoScreenshotElement() {
        var elems = document.getElementsByClassName("no-screenshot")
        for (var t of elems) {
            // t.style.visibility = 'visible';
            t.style.display = 'block';
        }
    }

    function getScreenshot() {
        hideNoScreenshotElement()
        html2canvas(document.getElementById("capture")).then(function (canvas) {
            snackBar("截图完成，正在处理，请稍后", 1000)
            canvas.toBlob(function (blob) {
                showNoScreenshotElement()
                // var url = URL.createObjectURL(blob);
                let imgfile = new File([blob], 'imgfile.jpg', {type: 'image/jpg'})
                let formData = new FormData()
                formData.append('file', imgfile)
                $.ajax({
                    type: 'POST',
                    url: '/api/uploadTempImage.do',
                    data: formData,
                    cache: false,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        console.log(data);
                        if (data["status"] === 0) {
                            console.log("上传成功")
                            let tempimgurl = "/api/getTempImage.do?fn=" + data["obj"]
                            mdui.alert('<div style="width: 100%; height: 256px"><img class="mdui-img-fluid" src="' + tempimgurl + '" alt="请长按保存" /></div>', '请长按保存');
                        }
                    },
                    error: function (data) {
                        console.log(data)
                    }
                });
            });
        });
    }

    loadImage()
    $("#img-input").on("change", function (e) {
        uploadImage()
    });
    zzInit()
</script>
</body>
</html>
